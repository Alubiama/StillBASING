name: Auto Deploy to Root (Simple)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # Для push в другой репозиторий

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout StillBASING
        uses: actions/checkout@v4
        with:
          path: StillBASING

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and Build
        working-directory: ./StillBASING
        run: |
          npm ci
          npm run build

      - name: Checkout alubiama.github.io
        uses: actions/checkout@v4
        with:
          repository: Alubiama/alubiama.github.io
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo

      - name: Deploy files
        run: |
          # Удалить старые файлы (кроме .git)
          cd target-repo
          find . -maxdepth 1 ! -name '.git' ! -name 'README.md' ! -name '.' ! -name '..' -exec rm -rf {} +

          # Копировать новые файлы
          cp -r ../StillBASING/dist/* .

          # Проверка
          ls -la

      - name: Commit and Push
        working-directory: ./target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy from StillBASING @ $(cd ../StillBASING && git rev-parse --short HEAD)" || exit 0
          git push
